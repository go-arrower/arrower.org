"use strict";(self.webpackChunkarrower_org=self.webpackChunkarrower_org||[]).push([[49],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},g=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),p=c(n),g=r,m=p["".concat(l,".").concat(g)]||p[g]||d[g]||o;return n?a.createElement(m,s(s({ref:t},u),{},{components:n})):a.createElement(m,s({ref:t},u))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,s=new Array(o);s[0]=g;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i[p]="string"==typeof e?e:r,s[1]=i;for(var c=2;c<o;c++)s[c]=n[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}g.displayName="MDXCreateElement"},8862:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>c});var a=n(7462),r=(n(7294),n(3905));const o={sidebar_position:1},s="Repeating Tasks",i={unversionedId:"basics/repeating-tasks/index",id:"basics/repeating-tasks/index",title:"Repeating Tasks",description:"If you want to run repeating tasks, arrower utilises pgcron.",source:"@site/docs/basics/04-repeating-tasks/index.md",sourceDirName:"basics/04-repeating-tasks",slug:"/basics/repeating-tasks/",permalink:"/docs/basics/repeating-tasks/",draft:!1,editUrl:"https://github.com/go-arrower/arrower.org/tree/master/docs/basics/04-repeating-tasks/index.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Jobs",permalink:"/docs/basics/jobs/"},next:{title:"Testing",permalink:"/docs/basics/testing/"}},l={},c=[{value:"Scheduling Tasks",id:"scheduling-tasks",level:2},{value:"Scheduling Complex Tasks as Jobs",id:"scheduling-complex-tasks-as-jobs",level:2},{value:"Postgres Image With pg_cron",id:"postgres-image-with-pg_cron",level:2}],u={toc:c},p="wrapper";function d(e){let{components:t,...n}=e;return(0,r.kt)(p,(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"repeating-tasks"},"Repeating Tasks"),(0,r.kt)("p",null,"If you want to run repeating tasks, arrower utilises ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/citusdata/pg_cron"},"pg_cron"),"."),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"TODO Link to the architectural vision of utilising postgres as much as possible")),(0,r.kt)("h2",{id:"scheduling-tasks"},"Scheduling Tasks"),(0,r.kt)("p",null,"Also consult the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/citusdata/pg_cron"},"official documentation")," of pg_cron."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"-- Delete old data on Saturday at 3:30am (GMT)\nSELECT cron.schedule('30 3 * * 6', $$DELETE FROM events WHERE event_time < now() - interval '1 week'$$);\n schedule\n----------\n       42\n\n-- Vacuum every day at 10:00am (GMT)\nSELECT cron.schedule('nightly-vacuum', '0 10 * * *', 'VACUUM');\n schedule\n----------\n       43\n\n-- Change to vacuum at 3:00am (GMT)\nSELECT cron.schedule('nightly-vacuum', '0 3 * * *', 'VACUUM');\n schedule\n----------\n       43\n\n-- Stop scheduling jobs\nSELECT cron.unschedule('nightly-vacuum' );\n unschedule \n------------\n t\n\nSELECT cron.unschedule(42);\n unschedule\n------------\n          t\n\n-- Vacuum every Sunday at 4:00am (GMT) in a database other than the one pg_cron is installed in\nSELECT cron.schedule_in_database('weekly-vacuum', '0 4 * * 0', 'VACUUM', 'some_other_database');\n schedule\n----------\n       44\n\n-- Call a stored procedure every 5 seconds\nSELECT cron.schedule('process-updates', '5 seconds', 'CALL process_updates()');\n\n-- Process payroll at 12:00 of the last day of each month\nSELECT cron.schedule('process-payroll', '0 12 $ * *', 'CALL process_payroll()');\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"}," \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 min (0 - 59)\n \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 hour (0 - 23)\n \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 day of month (1 - 31) or last day of the month ($)\n \u2502 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 month (1 - 12)\n \u2502 \u2502 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 day of week (0 - 6) (0 to 6 are Sunday to\n \u2502 \u2502 \u2502 \u2502 \u2502                  Saturday, or use names; 7 is also Sunday)\n \u2502 \u2502 \u2502 \u2502 \u2502\n \u2502 \u2502 \u2502 \u2502 \u2502\n * * * * *\n")),(0,r.kt)("p",null,"An easy way to create a cron schedule is: ",(0,r.kt)("a",{parentName:"p",href:"http://crontab.guru/"},"crontab.guru"),"."),(0,r.kt)("h2",{id:"scheduling-complex-tasks-as-jobs"},"Scheduling Complex Tasks as Jobs"),(0,r.kt)("p",null,"The repeating tasks introduced above rely on and execute SQL statements only.\nIn some cases this might be to limiting for your needs.\nIf you need to execute more complex business logic, use the cron to insert a row into the jobs table.\nThis way the ",(0,r.kt)("a",{parentName:"p",href:"./jobs#inserting-jobs-into-the-database"},"Jobs")," system is taking over,\nallowing you to perform any kind of operation without the limits of SQL."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT cron.schedule('your-custom-cron', '* * * * *',\n$$INSERT INTO arrower.gue_jobs(job_id, created_at, updated_at, run_at, queue, job_type, priority, args)\nVALUES (\ngenerate_ulid(), now(), now(), now(),\n'', 'MyJob', 0,\n(json_build_object('jobData', '{}') #>> '{}')::BYTEA);$$);\n")),(0,r.kt)("h2",{id:"postgres-image-with-pg_cron"},"Postgres Image With pg_cron"),(0,r.kt)("p",null,"You can use any (managed) database that has the pg_cron extension installed.\nAlternatively, use the docker image ",(0,r.kt)("inlineCode",{parentName:"p"},"ghcr.io/go-arrower/postgres")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"docker pull ghcr.io/go-arrower/postgres:latest\n")),(0,r.kt)("p",null,"The image installs the extension into the default database ",(0,r.kt)("inlineCode",{parentName:"p"},"postges")," and makes it available to your database,\nas if it was installed there."),(0,r.kt)("p",null,"The image is regenerated every week, so that you might have the latest version of postgres and its base image available to you."),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"Link ADL on why this is.\nTesting and limitations of pg_cron")),(0,r.kt)("p",null,"If you want to use the cron from a different user or database, you might have to fine-tune your setup:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Ensure your user can access the cron schema:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"-- Inside the database where pg_cron is installed:\n-- grant usage to regular user\nGRANT USAGE ON SCHEMA cron TO your_username;\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"The arrower migrations assume pg_cron is installed in the database ",(0,r.kt)("inlineCode",{parentName:"li"},"postgres")," if this is not the case\nupdate the database used in the migrations, see ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/go-arrower/arrower/blob/master/postgres/migrations/000002_create_pg_cron_extension.up.sql"},"create_pg_cron_extension.up.sql"))))}d.isMDXComponent=!0}}]);