"use strict";(self.webpackChunkarrower_org=self.webpackChunkarrower_org||[]).push([[253],{5157:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>l});var s=t(5893),r=t(1151);const o={},i="Jobs",a={id:"basics/jobs/index",title:"Jobs",description:"For everything that has to run in the background",source:"@site/docs/basics/05-jobs/index.md",sourceDirName:"basics/05-jobs",slug:"/basics/jobs/",permalink:"/docs/basics/jobs/",draft:!1,unlisted:!1,editUrl:"https://github.com/go-arrower/arrower.org/tree/master/docs/basics/05-jobs/index.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Usecases",permalink:"/docs/basics/usecases/"},next:{title:"Alternatives",permalink:"/docs/basics/jobs/alternatives"}},c={},l=[{value:"Key Characteristics",id:"key-characteristics",level:2},{value:"Queue Interface",id:"queue-interface",level:2},{value:"Enqueue Jobs",id:"enqueue-jobs",level:2},{value:"Run Job in the Future",id:"run-job-in-the-future",level:3},{value:"Prioritising Jobs",id:"prioritising-jobs",level:3},{value:"Repeating Tasks",id:"repeating-tasks",level:2},{value:"Process Jobs",id:"process-jobs",level:2},{value:"Accessing the Transaction of the Job",id:"accessing-the-transaction-of-the-job",level:3},{value:"Different Queues",id:"different-queues",level:2},{value:"Testing",id:"testing",level:2},{value:"UI &amp; Observability",id:"ui--observability",level:2}];function d(e){const n={a:"a",admonition:"admonition",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"jobs",children:"Jobs"}),"\n",(0,s.jsx)(n.p,{children:"For everything that has to run in the background\n(asynchronous): jobs, tasks, long-running operations, bulk processing,\ncleanups, notifications, etc."}),"\n",(0,s.jsx)(n.p,{children:"A design goal is to keep the developer focussed on the application and\nin the mindset of the domain. Explicitly freeing you from\nrelated tasks like serialising the job payload or instrumenting it,\nso that the application is easy to understand, extend, and maintain."}),"\n",(0,s.jsxs)(n.p,{children:["Jobs run on top of PostgreSQL and use transactional enqueuing.\nAs jobs are enqueued in the same transaction as\nother database operations, this prevents common issues with\nbackground tasks in distributed systems and is an easy architecture and\neasy to understand and debug. ",(0,s.jsx)(n.br,{}),"\n","Workers uses transaction-level locks and db operations performed in the worker\nwill commit or rollback with job's transaction."]}),"\n",(0,s.jsx)(n.h2,{id:"key-characteristics",children:"Key Characteristics"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Transactional queue"}),(0,s.jsx)(n.br,{}),"\n","Simple development and exactly once guarantee (no need for distributed transactions or 2X protocols)."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Different Queues"}),(0,s.jsx)(n.br,{}),"\n","Arrower provides a default queue out of the box, but you can create as many queues as you need.\nEach queue has it's own set of workers and are independent of each other."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Automatic retries on job or worker failure"}),(0,s.jsx)(n.br,{}),"\n","Failing jobs are automatically retried with a growing backoff."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Different priorities per queue"}),(0,s.jsx)(n.br,{}),"\n","Prioritise your jobs, so important jobs are processed first.\nA time based and a priority based strategy is available."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Scheduling of jobs"}),(0,s.jsx)(n.br,{}),"\n","Run a job at a specific time in the future."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"History and insight into the Queues"}),(0,s.jsx)(n.br,{}),"\n","With the admin UI you inspect and manage all your queues, jobs, and the history,\nthis gives you visibility into what is going on at all times."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Automatic instrumentation"}),(0,s.jsx)(n.br,{}),"\n","Metrics and traces are provided automatically and can be inspected in Grafana."]}),"\n",(0,s.jsx)(n.admonition,{type:"caution",children:(0,s.jsx)(n.p,{children:"The use of PostgreSQL as a backend has implications\non what is possible with this setup in terms of scale\nbut is totally fine for small to medium-sized apps."})}),"\n",(0,s.jsx)(n.h2,{id:"queue-interface",children:"Queue Interface"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"type Queue interface {\n    Enqueue(ctx context.Context, job Job, jobOptions ...JobOption) error\n    Schedule(spec string, job Job) error\n\n    RegisterJobFunc(func (ctx context.Context, job Job) error) error\n    Shutdown(ctx context.Context) error\n}\n\ntype Enqueuer interface {\n    Enqueue(ctx context.Context, job Job, jobOptions ...JobOption) error\n}\n\ntype Scheduler interface {\n    Schedule(spec string, job Job) error\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Use the more specific interfaces ",(0,s.jsx)(n.code,{children:"Enqueuer"})," and ",(0,s.jsx)(n.code,{children:"Scheduler"})," as dependencies,\nif you want to limit the use cases ability to manage the queue, e.g. shutdown."]}),"\n",(0,s.jsx)(n.h2,{id:"enqueue-jobs",children:"Enqueue Jobs"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"var jq jobs.Enqueuer\n\n// enqueue a single job\n_ = jq.Enqueue(ctx, myJob{Payload: 1})\n\n// enqueue multiple jobs as a batch operation\n_ = jq.Enqueue(ctx, []myJob{{Payload: 1}, {Payload: 2}})\n\n// enqueue multiple jobs of different kinds\n_ = jq.Enqueue(ctx, []any{myJob{Payload: 1}, otherJob{}})\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://github.com/go-arrower/arrower/blob/master/jobs/jobs.business_test.go",children:"See working example"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["If the ",(0,s.jsx)(n.code,{children:"ctx"})," contains a transaction, it is used to persist the job to the database.\nKeeping your job consistent with your application data."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"run-job-in-the-future",children:"Run Job in the Future"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"_ = jq.Enqueue(ctx, myJob{}, jobs.WithRunAt(time.Now().Add(10*time.Minute)))\n"})}),"\n",(0,s.jsx)(n.h3,{id:"prioritising-jobs",children:"Prioritising Jobs"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"// a lower number means a higher priority\n_ = jq.Enqueue(ctx, myJob{}, jobs.WithPriority(-1))\n"})}),"\n",(0,s.jsx)(n.h2,{id:"repeating-tasks",children:"Repeating Tasks"}),"\n",(0,s.jsx)(n.p,{children:"Repeating tasks build on jobs. They are scheduled,\nand you are responsible to make sure there are enough workers to execute them on time.\nConsider if any peak numbers of jobs are scheduled and\nif it is critical that they are handled immediately if you want to avoid delayed execution."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'_ = jq.Schedule("0 4 * * *", myJob{})\n\n// with optional parameters, the cron job can be more flexible\n_ = jq.Schedule("0 4 * * *", myJob{Payload: "custom-param-for-worker"})\n'})}),"\n",(0,s.jsx)(n.p,{children:"Use the crontab format as follows:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Schedule schedules a Job repeatingly. Spec is the crontab format with some additional nonstandard definitions.\n\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 minute (0 - 59)\n\u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 hour (0 - 23)\n\u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 day of the month (1 - 31)\n\u2502 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 month (1 - 12)\n\u2502 \u2502 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 day of the week (0 - 6) (Sunday to Saturday;\n\u2502 \u2502 \u2502 \u2502 \u2502                                   7 is also Sunday on some systems)\n\u2502 \u2502 \u2502 \u2502 \u2502\n\u2502 \u2502 \u2502 \u2502 \u2502\n* * * * *\n\n`@yearly` (or `@annually`)   => `0 0 1 1 *`\n`@monthly`                   => `0 0 1 * *`\n`@weekly`                    => `0 0 * * 0`\n`@daily` (or `@midnight`)    => `0 0 * * *`\n`@hourly`                    => `0 * * * *`\n`@every [interval]` where interval is the duration string that can be parsed by time.ParseDuration.\n"})}),"\n",(0,s.jsxs)(n.p,{children:["An easy way to create a cron schedule is: ",(0,s.jsx)(n.a,{href:"http://crontab.guru/",children:"crontab.guru"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"process-jobs",children:"Process Jobs"}),"\n",(0,s.jsxs)(n.p,{children:["Each job is processed asynchronously in its own worker go routine.\nTo be able to process jobs it is important to register a ",(0,s.jsx)(n.code,{children:"JobFunc"})," on the appropriate queue."]}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["The function has to have the signature of ",(0,s.jsx)(n.code,{children:"func(ctx context.Context, job YourJobType) error"})]})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"var jq jobs.Queue\n\n_ = jq.RegisterJobFunc(func(ctx context.Context, job myJob) error {\n\t// process your job here...\n\t\n\treturn nil\n}) \n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Returning an error will reschedule the job with an exponential backoff"}),"\n",(0,s.jsxs)(n.li,{children:["A call to ",(0,s.jsx)(n.code,{children:"RegisterJobFunc"})," does start the worker pool after a certain time.",(0,s.jsx)(n.br,{}),"\n","If the worker poll got started already, subsequent calls to ",(0,s.jsx)(n.code,{children:"RegisterJobFunc"}),"\nwill shut it down and restart it automatically blocking your call for that time."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"accessing-the-transaction-of-the-job",children:"Accessing the Transaction of the Job"}),"\n",(0,s.jsx)(n.p,{children:"To keep your application consistent perform all db changes on the same transaction as the job."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"If the job returns without an error the transaction is committed"}),"\n",(0,s.jsx)(n.li,{children:"If the job returns an error the transaction is rolled back and the job retried\nwith an increasing backoff."}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"var jq jobs.Queue\n\n_ = jq.RegisterJobFunc(func(ctx context.Context, job myJob) error {\n    tx, txOk := ctx.Value(postgres.CtxTX).(pgx.Tx)\n\n    // change db state here...\n\t\n    return someErr // rolls back all db changes\n}) \n"})}),"\n",(0,s.jsx)(n.h2,{id:"different-queues",children:"Different Queues"}),"\n",(0,s.jsx)(n.p,{children:"Arrower supports multiple job queues, but each queue has to be instantiated. If no explicit queue name is\nset, the default queue is used."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'jq, err := jobs.NewPostgresJobs(alog.NewNoopLogger(), noop.NewMeterProvider(), noop.NewTracerProvider(), pgHandler.PGx,\n    jobs.WithQueue("queueName"), // set the name of the queue you want to run\n)\n'})}),"\n",(0,s.jsx)(n.p,{children:"Each queue can be configured with these optional options."}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Option"}),(0,s.jsx)(n.th,{children:"Default"}),(0,s.jsx)(n.th,{children:"Behaviour"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"WithQueue"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"<empty>"})}),(0,s.jsx)(n.td,{children:"Set the name of the queue"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"WithPollInterval"})}),(0,s.jsx)(n.td,{children:"5 seconds"}),(0,s.jsx)(n.td,{children:"Set the interval to query the database for new jobs."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"WithPoolSize"})}),(0,s.jsx)(n.td,{children:"10"}),(0,s.jsx)(n.td,{children:"Set the amount of workers"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"WithPoolName"})}),(0,s.jsx)(n.td,{children:"a random name"}),(0,s.jsx)(n.td,{children:"Set the a name for this worker pool instance"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"WithWorkerPollStrategy"})}),(0,s.jsx)(n.td,{children:"PriorityPollStrategy"}),(0,s.jsx)(n.td,{children:"Set the  poll strategy"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["The queue is instrumented to give you ",(0,s.jsx)(n.a,{href:"./observability",children:"observability"})," out of the box.\nYou'll have logs, metrics, and traces available for you."]}),"\n",(0,s.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,s.jsx)(n.p,{children:"As the Job's handlers are just functions you can test them normally, like you would do anyway."}),"\n",(0,s.jsxs)(n.p,{children:["What is remaining is to ensure the right Jobs get enqueued on the emitting site.\nFor this an in memory implementation of the ",(0,s.jsx)(n.code,{children:"jobs.Queue"})," interface is available, you can use in tests. It comes\nwith some additional methods, to make testing easier:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Custom assertions for the job queue"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:"  jq := jobs.NewTestingJobs()\n  jassert := jq.Assert(t)\n\n  // asserts the queue is empty\n  jassert.Empty()\n\n  _ = jq.Enqueue(ctx, myJob{})\n\n  // asserts the queue is not empty\n  jassert.NotEmpty()\n\n  // asserts the queue has exactly one Job of type `myJob`\n  jassert.Queued(myJob{}, 1)\n\n  // asserts the queue has 1 Job enqueued\n  jassert.QueuedTotal(1)\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsxs)(n.li,{children:["Custom test helpers beyond the ",(0,s.jsx)(n.code,{children:"jobs.Queue"})," interface"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'  jq := jobs.NewTestingJobs()\n\n  // get a Job without processing it, to assert Job details.\n  job := queue.GetFirstOf(myJob{}).(myJob)\n  assert.Equal(t, "myName", job.Name)\n\n  // resets the queue to be empty\n  jq.Reset() \n'})}),"\n",(0,s.jsx)(n.h2,{id:"ui--observability",children:"UI & Observability"}),"\n",(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(n.a,{href:"/docs/basics/observability",children:"Observability for more details"})]}),"\n",(0,s.jsx)("img",{src:t(7441).Z}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Jobs integrate with the observability setup of Arrower"}),"\n",(0,s.jsx)(n.li,{children:"The originating span is persisted and referenced in each Job run"}),"\n",(0,s.jsx)(n.li,{children:"Failing Job runs are marked and retried automatically"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},7441:(e,n,t)=>{t.d(n,{Z:()=>s});const s=t.p+"assets/images/queue-otel-tracing-413652944366e601807e6c64be9c2c2d.png"},1151:(e,n,t)=>{t.d(n,{Z:()=>a,a:()=>i});var s=t(7294);const r={},o=s.createContext(r);function i(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);