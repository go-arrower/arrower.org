"use strict";(self.webpackChunkarrower_org=self.webpackChunkarrower_org||[]).push([[7464],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var o=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},i=Object.keys(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=o.createContext({}),p=function(e){var t=o.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},c=function(e){var t=p(e.components);return o.createElement(l.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},y=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=p(n),y=r,m=d["".concat(l,".").concat(y)]||d[y]||u[y]||i;return n?o.createElement(m,a(a({ref:t},c),{},{components:n})):o.createElement(m,a({ref:t},c))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,a=new Array(i);a[0]=y;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[d]="string"==typeof e?e:r,a[1]=s;for(var p=2;p<i;p++)a[p]=n[p];return o.createElement.apply(null,a)}return o.createElement.apply(null,n)}y.displayName="MDXCreateElement"},6743:(e,t,n)=>{n.r(t),n.d(t,{Pyramid:()=>c,assets:()=>l,contentTitle:()=>a,default:()=>y,frontMatter:()=>i,metadata:()=>s,toc:()=>p});var o=n(7462),r=(n(7294),n(3905));const i={sidebar_position:2},a="Testing",s={unversionedId:"basics/testing/index",id:"basics/testing/index",title:"Testing",description:"Testing Pyramid",source:"@site/docs/basics/03-testing/index.md",sourceDirName:"basics/03-testing",slug:"/basics/testing/",permalink:"/docs/basics/testing/",draft:!1,editUrl:"https://github.com/go-arrower/arrower.org/tree/master/docs/basics/03-testing/index.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Repeating Tasks",permalink:"/docs/basics/repeating-tasks/"},next:{title:"Observability",permalink:"/docs/basics/observability/"}},l={},p=[{value:"Testing Pyramid",id:"testing-pyramid",level:3},{value:"Unit Testing",id:"unit-testing",level:2},{value:"Extending the Repository",id:"extending-the-repository",level:3},{value:"Overwriting a Method",id:"overwriting-a-method",level:3},{value:"Integration Testing",id:"integration-testing",level:2},{value:"Docker Images for Integration Testing",id:"docker-images-for-integration-testing",level:3}],c=()=>(0,r.kt)("div",null,(0,r.kt)("img",{src:n(2496).Z,alt:"schema of testing pyramid",style:{width:"60%",float:"right"}}),(0,r.kt)("span",null,"Arrower is using the following terminology, and the picture at the right is only a sketch of the dynamics of the testing pyramid.",(0,r.kt)("br",null),(0,r.kt)("br",null),(0,r.kt)("ul",null,(0,r.kt)("li",null,"Manual"),(0,r.kt)("li",null,"UI"),(0,r.kt)("li",null,"E2E"),(0,r.kt)("li",null,"Integration"),(0,r.kt)("li",null,"Unit"))),(0,r.kt)("div",{style:{clear:"both"}})),d={toc:p,Pyramid:c},u="wrapper";function y(e){let{components:t,...n}=e;return(0,r.kt)(u,(0,o.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"testing"},"Testing"),(0,r.kt)("h3",{id:"testing-pyramid"},"Testing Pyramid"),(0,r.kt)("p",null,"It's important to understand that this is just one view.\nYou might find parts of it useful but also have your own experience, fondness, and approach to testing.\nThat is fine! Arrower want's to support, so you can do as you like."),(0,r.kt)("p",null,"The style, completeness, and amount of test cases might also depend on\nwhich phase your project is in at any given point,\nwhile prototyping you will want to employ a different testing strategy than when your maintaining something."),(0,r.kt)(c,{mdxType:"Pyramid"}),(0,r.kt)("h2",{id:"unit-testing"},"Unit Testing"),(0,r.kt)("p",null,"Unit tests come in many forms. Arrower provides you with a set of helpers that make your life easier."),(0,r.kt)("p",null,"If you're using the repository pattern it is cumbersome to always implement an in memory copy of the repository.\nUse ",(0,r.kt)("inlineCode",{parentName:"p"},"repo := tests.NewMemoryRepository[Entity, EntityID]()")," to generate a repository that comes with a lot of\noften used methods out of the box."),(0,r.kt)("p",null,"It is implicitly assumed that the entity has a field named ",(0,r.kt)("inlineCode",{parentName:"p"},"ID")," that will be used as primary key.\nAdditionally, the ID has to have an underlying type of string and can not be an int.  "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"type Repository[E any, ID ~string] interface {\n    NextID(context.Context) ID\n\n    Create(context.Context, E) error\n    Read(context.Context, ID) (E, error)\n    Update(context.Context, E) error\n    Delete(context.Context, E) error\n\n    All(context.Context) ([]E, error)\n    AllByIDs(context.Context, []ID) ([]E, error)\n    FindAll(ctx context.Context) ([]E, error)\n    FindByID(context.Context, ID) (E, error)\n    FindByIDs(context.Context, []ID) ([]E, error)\n    Exists(context.Context, ID) (bool, error)\n    ExistsByID(context.Context, ID) (bool, error)\n    ExistAll(context.Context, []ID) (bool, error)\n    ExistByIDs(context.Context, []ID) (bool, error)\n    Contains(context.Context, ID) (bool, error)\n    ContainsID(context.Context, ID) (bool, error)\n    ContainsIDs(context.Context, []ID) (bool, error)\n    ContainsAll(context.Context, []ID) (bool, error)\n\n    Count(context.Context) (int, error)\n    Length(context.Context) (int, error)\n    Empty(context.Context) (bool, error)\n    IsEmpty(context.Context) (bool, error)\n\n    Save(context.Context, E) error\n    SaveAll(context.Context, []E) error\n    UpdateAll(context.Context, []E) error\n    Add(context.Context, E) error\n    AddAll(context.Context, []E) error\n\n    DeleteByID(context.Context, ID) error\n    DeleteByIDs(context.Context, []ID) error\n    DeleteAll(context.Context) error\n}\n")),(0,r.kt)("h3",{id:"extending-the-repository"},"Extending the Repository"),(0,r.kt)("p",null,"If you have methods that are not supported out of the box you can embed the repository and implement your missing methods."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"func NewMemoryRepository() *MemoryRepository {\n    return &MemoryRepository{\n        MemoryRepository: tests.NewMemoryRepository[Entity, EntityID](),\n    }\n}\n\ntype MemoryRepository struct {\n    *tests.MemoryRepository[Entity, EntityID]\n}\n\n// your custom method\nfunc (repo *MemoryRepository) FindByLogin(ctx context.Context, login string) (Entity, error) {\n    all, _ := repo.All(ctx)\n\n    for _, e := range all {\n        if e.Login == login {\n            return u, nil\n        }\n    }\n\n    return Entity{}, ErrNotFound\n}\n")),(0,r.kt)("h3",{id:"overwriting-a-method"},"Overwriting a Method"),(0,r.kt)("p",null,"You can even fine tune the behaviour of a method, if your requirements demand it."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"func NewMemoryRepository() *MemoryRepository {\n    return &MemoryRepository{\n        MemoryRepository: tests.NewMemoryRepository[Entity, EntityID](),\n    }\n}\n\ntype MemoryRepository struct {\n    *tests.MemoryRepository[Entity, EntityID]\n}\n\nfunc (repo *MemoryRepository) Count(ctx context.Context) (int, error) {\n    return -1, nil\n}\n\n// calling your implementation\nrepo := tests.NewMemoryRepository[Entity, EntityID]()\nrepo.Count(ctx) // result: -1\n")),(0,r.kt)("h2",{id:"integration-testing"},"Integration Testing"),(0,r.kt)("p",null,"Sometimes you just don't want to test against an in memory implementation and need to see if your application behaves\ncorrectly against the real database."),(0,r.kt)("p",null,"This pattern spins up a postgres database inside a docker container and removes the container after the test has\nfinished automatically.\nThe ",(0,r.kt)("inlineCode",{parentName:"p"},"NewTestDatabase")," method will ensure you can safely run all tests in parallel by:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Creating a new randomly named database for each test case"),(0,r.kt)("li",{parentName:"ul"},"Performing schema migration"),(0,r.kt)("li",{parentName:"ul"},"Seeding the database with test data")),(0,r.kt)("p",null,"The testdata is seeded with the project ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/go-testfixtures/testfixtures"},"testfixtures"),"\nand if an file ",(0,r.kt)("inlineCode",{parentName:"p"},"testdata/fixtures/_common.yaml")," exists it is automatically loaded. For additional data per test case\ntake a look at ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/go-testfixtures/testfixtures#-single-file-on-multiple-tables"},"multiple tables in one file")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'//go:build integration\n\npackage yourpackage_test\n\nvar pgHandler *tests.PostgresDocker\n\nfunc TestMain(m *testing.M) {\n    pgHandler = tests.GetPostgresDockerForIntegrationTestingInstance()\n\n    //\n    // Run tests\n    code := m.Run()\n\n    pgHandler.Cleanup()\n    os.Exit(code)\n}\n\nfunc TestSomething(t *testing.T) {\n    t.Parallel()\n\n    pg := pgHandler.NewTestDatabase()\n\n    // use pg to initialise your test dependencies like a postgres repository \n}\n\nfunc TestSomethingOther(t *testing.T) {\n    t.Parallel()\n\n    // load multiple additional test fixture files to seed the database\n    pg := pgHandler.NewTestDatabase([]string{\n        "testdata/fixtures/something-other-user.yaml",\n        "testdata/fixtures/something-other-posts.yaml",\n    })\n    \n    _ = pg.PGx() // direct access to the pgx connection pool \n}\n')),(0,r.kt)("p",null,"If you depend on other services for your testing use the ",(0,r.kt)("inlineCode",{parentName:"p"},"tests.StartDockerContainer")," helper to start any service\ninside a docker container. With ",(0,r.kt)("inlineCode",{parentName:"p"},"tests.GetDockerContainerInstance")," only one docker container is\ncreated and returned each time, so that your system and CI does not get swamped with too many containers.\nCheck out the ",(0,r.kt)("inlineCode",{parentName:"p"},"tests.GetPostgresDockerForIntegrationTestingInstance")," to see it in action for the testing against a postgres\ndatabase as shown above."),(0,r.kt)("h3",{id:"docker-images-for-integration-testing"},"Docker Images for Integration Testing"),(0,r.kt)("p",null,"Arrower ships all images you would need to operate and test a setup.\nSee ",(0,r.kt)("a",{parentName:"p",href:"./repeating-tasks#postgres-image-with-pg_cron"},"Tasks")," on how to use the postgres image with a\npreinstalled ",(0,r.kt)("inlineCode",{parentName:"p"},"pg_cron")," extension already"))}y.isMDXComponent=!0},2496:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/pyramid-fb70a76771013041e8425615d6b4d2d2.png"}}]);